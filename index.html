<script>
/* ===== Jobtitel-Autocomplete aus CSV ===== */
const JOBS = [];
const MAX_SUG = 34;
const jobInput = document.getElementById('job');
const sugList  = document.getElementById('jobSuggest');

function norm(s){
  return (s||'').toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,''); // grobe Diakritika-Entfernung
}

function renderSuggestions(items){
  if(!items.length){ sugList.classList.remove('show'); sugList.innerHTML=''; return; }
  sugList.innerHTML = items.slice(0,MAX_SUG)
    .map((t,i)=>`<li role="option" data-idx="${i}">${t}</li>`).join('');
  sugList.classList.add('show');
  activeIndex = -1;
}

function filterJobs(q){
  const n = norm(q);
  if(n.length < 4) return [];
  return JOBS.filter(t => norm(t).includes(n)).slice(0, MAX_SUG);
}

let activeIndex = -1;

jobInput.addEventListener('input', () => {
  const q = jobInput.value.trim();
  renderSuggestions(filterJobs(q));
});

jobInput.addEventListener('keydown', (e) => {
  const items = [...sugList.querySelectorAll('li')];
  if(!sugList.classList.contains('show') || !items.length) return;

  if(e.key === 'ArrowDown'){
    e.preventDefault();
    activeIndex = (activeIndex + 1) % items.length;
  } else if(e.key === 'ArrowUp'){
    e.preventDefault();
    activeIndex = (activeIndex - 1 + items.length) % items.length;
  } else if(e.key === 'Enter'){
    if(activeIndex >= 0){
      e.preventDefault();
      jobInput.value = items[activeIndex].textContent;
      sugList.classList.remove('show');
    }
    return;
  } else {
    return; // andere Tasten ignorieren
  }
  items.forEach((li,i)=>li.setAttribute('aria-selected', i===activeIndex ? 'true' : 'false'));
  items[activeIndex].scrollIntoView({block:'nearest'});
});

sugList.addEventListener('click', (e) => {
  const li = e.target.closest('li');
  if(!li) return;
  jobInput.value = li.textContent;
  sugList.classList.remove('show');
  jobInput.focus();
});

document.addEventListener('click', (e) => {
  if(!sugList.contains(e.target) && e.target!==jobInput){
    sugList.classList.remove('show');
  }
});

/* CSV laden */
(async function loadJobs(){
  try{
    const res = await fetch('assets/data/jobtitel.csv', {cache:'no-store'});
    if(!res.ok) throw new Error('CSV not found');
    const text = await res.text();
    const rows = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    // eindeutige, sortierte Liste (optional)
    const uniq = Array.from(new Set(rows));
    uniq.sort((a,b)=>a.localeCompare(b,'de',{sensitivity:'base'}));
    JOBS.push(...uniq);
  }catch(err){
    console.warn('Jobtitel-CSV konnte nicht geladen werden:', err);
  }
})();
</script>
